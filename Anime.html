<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù¾ÙˆØªØ§ ØªÙˆ Ø§Ù†ÛŒÙ…Ù‡</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@1.0.0/dist/Vazirmatn.css">
  <style>
    :root {
      --bg-dark: #1a1a1a;
      --bg-light: #2f2f2f;
      --text-light: #e0e0e0;
      --accent: #ff4757;
      --accent-light: rgba(255, 71, 87, 0.2);
      --font-main: 'Vazirmatn', sans-serif;
      --radius: 8px;
      --transition: 0.3s;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:var(--font-main); background:var(--bg-dark); color:var(--text-light); direction:rtl; line-height:1.6; }
    header { position:fixed; top:0; left:0; right:0; background:linear-gradient(90deg,var(--bg-light),var(--bg-dark)); display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; box-shadow:0 2px 8px rgba(0,0,0,0.7); z-index:1000; backdrop-filter:blur(10px); }
    header h2 { font-size:1.8rem; color:var(--accent); }
    header .btn { margin-left:1rem; font-size:0.95rem; background:none; border:2px solid var(--accent); border-radius:var(--radius); padding:0.5rem 1rem; color:var(--accent); text-decoration:none; transition:var(--transition); }
    header .btn:hover { background:var(--accent); color:#fff; }
    .container { max-width:1000px; margin:6rem auto 2rem; padding:0 1rem; }
    .cover { width:100%; max-height:480px; object-fit:cover; border-radius:var(--radius); box-shadow:0 8px 20px rgba(0,0,0,0.8); margin-bottom:1.5rem; transition:transform var(--transition); }
    .cover:hover { transform:scale(1.02); }
    h1 { font-size:2.8rem; margin-bottom:0.5rem; color:var(--accent); text-shadow:1px 1px 6px rgba(0,0,0,0.9); }
    .meta { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem; }
    .meta span { background:var(--bg-light); padding:0.5rem 1rem; border-radius:var(--radius); display:flex; align-items:center; gap:0.5rem; box-shadow:0 4px 10px rgba(0,0,0,0.5); }
    .genres { display:flex; flex-wrap:wrap; gap:0.75rem; margin-bottom:2rem; }
    .genres span { background:var(--accent-light); color:var(--accent); padding:0.4rem 0.8rem; border-radius:var(--radius); font-weight:bold; }
    .section-title { font-size:1.6rem; margin:2rem 0 1rem; border-left:4px solid var(--accent); padding-left:0.75rem; }
    #episodes-list { list-style:none; display:flex; gap:1rem; overflow-x:auto; padding-bottom:0.5rem; }
    #episodes-list::-webkit-scrollbar { height:8px; }
    #episodes-list::-webkit-scrollbar-thumb { background:var(--accent); border-radius:var(--radius); }
    #episodes-list li { background:var(--bg-light); min-width:180px; padding:1rem; border-radius:var(--radius); box-shadow:0 4px 10px rgba(0,0,0,0.5); flex-shrink:0; text-align:center; }
    #episodes-list li a { display:inline-block; margin-top:0.75rem; background:var(--accent); color:#fff; padding:0.5rem 0; border-radius:var(--radius); width:100%; text-decoration:none; transition:var(--transition); }
    #episodes-list li a:hover { background:#e63946; }
    .description { margin-top:2rem; padding:1.5rem; background:var(--bg-light); border-left:4px solid var(--accent); border-radius:var(--radius); box-shadow:0 4px 15px rgba(0,0,0,0.5); line-height:1.8; font-size:1rem; }
    #episode-details { max-height:200px; overflow-y:auto; background:var(--bg-light); padding:0.75rem; border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,0.5); margin-bottom:1rem; }
    #admin-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; }
    #admin-panel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--bg-light); padding:2rem; border-radius:var(--radius); width:90%; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.7); z-index:2001; overflow-y:auto; max-height:90vh; }
    #admin-panel h3 { font-size:1.8rem; color:var(--accent); text-align:center; margin-bottom:1rem; }
    #admin-controls { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem; }
    #admin-controls label { grid-column:span 2; font-size:0.95rem; }
    #admin-controls input, #admin-controls textarea { grid-column:span 2; background:#3a3a3a; color:var(--text-light); padding:0.6rem; border:none; border-radius:var(--radius); transition:var(--transition); }
    #admin-controls input:focus, #admin-controls textarea:focus { outline:2px solid var(--accent); }
    #admin-controls textarea { min-height:100px; resize:vertical; }
    #save-btn, #close-admin { padding:0.6rem; border:none; border-radius:var(--radius); cursor:pointer; transition:var(--transition); }
    #save-btn { background:var(--accent); color:#fff; grid-column:span 1; }
    #close-admin { background:transparent; border:2px solid var(--accent); color:var(--accent); grid-column:span 1; }
    #save-btn:hover { opacity:0.9; }
    #close-admin:hover { background:var(--accent); color:#fff; }
    @media(max-width:600px) { .container { margin:5rem auto 1rem; } header { padding:0.8rem 1rem; } h1 { font-size:2rem; } #episodes-list li { min-width:140px; } #admin-controls { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h2>Ù¾ÙˆØªØ§ ØªÙˆ Ø§Ù†ÛŒÙ…Ù‡</h2>
    <div>
      <a href="index.html" class="btn">Ø®Ø§Ù†Ù‡</a>
      <button id="admin-login" class="btn">Ù…Ø¯ÛŒØ±ÛŒØª</button>
    </div>
  </header>

  <div id="admin-overlay"></div>
  <div id="admin-panel">
    <h3 id="admin-title"></h3>
    <input type="password" id="admin-pass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button id="admin-auth">ÙˆØ±ÙˆØ¯</button>
    <div id="admin-controls">
      <label for="slug-input">Ø´Ù†Ø§Ø³Ù‡ (Slug)</label>
      <input type="text" id="slug-input" placeholder="my-anime-slug">
      <label for="title-input">Ø¹Ù†ÙˆØ§Ù† Ø§Ù†ÛŒÙ…Ù‡</label>
      <input type="text" id="title-input">
      <label for="desc-input">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
      <textarea id="desc-input"></textarea>
      <label for="img-input">Ø¢Ø¯Ø±Ø³ Ø¹Ú©Ø³</label>
      <input type="text" id="img-input">
      <label for="date-input">ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±</label>
      <input type="date" id="date-input">
      <label for="genres-input">Ú˜Ø§Ù†Ø±Ù‡Ø§ (',' Ø¬Ø¯Ø§)</label>
      <input type="text" id="genres-input">
      <label for="rating-input">Ø§Ù…ØªÛŒØ§Ø²</label>
      <input type="number" step="0.1" min="0" max="10" id="rating-input">
      <label for="episodes-input">ØªØ¹Ø¯Ø§Ø¯ Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§</label>
      <input type="number" min="0" id="episodes-input">
      <div id="episode-details"></div>
      <label for="file-input">Ù„ÛŒÙ†Ú© ÙØ§ÛŒÙ„</label>
      <input type="text" id="file-input" placeholder="https://...">
      <button id="save-btn">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="close-admin" type="button">Ù„ØºÙˆ</button>
    </div>
  </div>

  <div class="container">
    <img id="cover" class="cover" alt="Ú©Ø§ÙˆØ±">
    <h1 id="title"></h1>
    <div class="meta">
      <span>ğŸ“…<strong>Ø§Ù†ØªØ´Ø§Ø±:</strong> <span id="date"></span></span>
      <span>â­<strong>Ø§Ù…ØªÛŒØ§Ø²:</strong> <span id="rating"></span></span>
      <span>ğŸ¬<strong>Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§:</strong> <span id="episodes"></span></span>
    </div>
    <div id="genres" class="genres"></div>
    <h2 class="section-title">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ø± Ù‚Ø³Ù…Øª</h2>
    <ul id="episodes-list"></ul>
    <div class="description" id="description"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient('https://mhtkysxhhrtaubakhfmn.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1odGt5c3hoaHJ0YXViYWtoZm1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0NjUyNTcsImV4cCI6MjA2MjA0MTI1N30.32077cavlx8PBTp6QOw1PK66RCH3FWlAiSDM39N0VHg');
    let currentId=null, newMode=false, episodeData=[];

    const adminLogin = document.getElementById('admin-login');
    const overlay    = document.getElementById('admin-overlay');
    const panel      = document.getElementById('admin-panel');
    const adminAuth  = document.getElementById('admin-auth');
    const adminPass  = document.getElementById('admin-pass');
    const controls   = document.getElementById('admin-controls');
    const closeBtn   = document.getElementById('close-admin');
    const saveBtn    = document.getElementById('save-btn');
    const adminTitle = document.getElementById('admin-title');

    const slugInput     = document.getElementById('slug-input');
    const titleInput    = document.getElementById('title-input');
    const descInput     = document.getElementById('desc-input');
    const imgInput      = document.getElementById('img-input');
    const dateInput     = document.getElementById('date-input');
    const genresInput   = document.getElementById('genres-input');
    const ratingInput   = document.getElementById('rating-input');
    const episodesInput = document.getElementById('episodes-input');
    const fileInput     = document.getElementById('file-input');

    const coverEl       = document.getElementById('cover');
    const titleEl       = document.getElementById('title');
    const dateEl        = document.getElementById('date');
    const ratingEl      = document.getElementById('rating');
    const episodesEl    = document.getElementById('episodes');
    const genresEl      = document.getElementById('genres');
    const descriptionEl = document.getElementById('description');
    const episodesList  = document.getElementById('episodes-list');
    const episodeDetails= document.getElementById('episode-details');

    // Admin open/close
    adminLogin.addEventListener('click',()=>{overlay.style.display='block';panel.style.display='block';controls.style.display='grid';adminAuth.style.display='block';adminPass.style.display='block';});
    closeBtn.addEventListener('click',closeAdmin);overlay.addEventListener('click',closeAdmin);
    function closeAdmin(){overlay.style.display='none';panel.style.display='none';}
    adminAuth.addEventListener('click',()=>{if(adminPass.value==='admin123'){controls.style.display='grid';adminAuth.style.display='none';adminPass.style.display='none';prepareForm();}else alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡');});

    // Generate episode fields
    function generateEpisodeFields(existing=[]){episodeDetails.innerHTML='';const count=parseInt(episodesInput.value)||0;for(let i=1;i<=count;i++){const div=document.createElement('div');div.style.marginBottom='0.5rem';const label=document.createElement('label');label.textContent=`Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‚Ø³Ù…Øª ${i}`;const input=document.createElement('input');input.type='text';input.id=`episode-url-${i}`;input.placeholder='https://...';const found=existing.find(e=>e.episode_number===i)||{};input.value=found.video_url||'';div.append(label,input);episodeDetails.append(div);}}
    episodesInput.addEventListener('change',()=>generateEpisodeFields(episodeData));

    // Load episodes list
    async function loadEpisodes(){if(!currentId)return;const {data}=await supabase.from('episodes').select('episode_number,video_url').eq('anime_id',currentId).order('episode_number');episodeData=data||[];episodesList.innerHTML='';data.forEach(ep=>{const li=document.createElement('li');li.innerHTML=`Ù‚Ø³Ù…Øª ${ep.episode_number}<a href="${ep.video_url}" download>Ø¯Ø§Ù†Ù„ÙˆØ¯</a>`;episodesList.append(li);});}

    // Load anime data
    async function loadAnime(){const parts=window.location.pathname.split('/').filter(p=>p);const key=parts.pop();let res;if(/^[0-9]+$/.test(key)){newMode=false;currentId=parseInt(key,10);res=await supabase.from('anime').select('*').eq('id',currentId).single();}else{newMode=false;res=await supabase.from('anime').select('*').eq('slug',key).single();}if(res.error||!res.data){newMode=true;renderEmpty();return;}renderData(res.data);await loadEpisodes();generateEpisodeFields(episodeData);}
    function renderEmpty(){adminTitle.textContent='Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÛŒÙ…Ù‡';saveBtn.textContent='Ø§ÛŒØ¬Ø§Ø¯';slugInput.disabled=false;slugInput.value='';titleEl.textContent='Ø§Ù†ÛŒÙ…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯';coverEl.src='';dateEl.textContent='Ù†Ø§Ù…Ø´Ø®Øµ';ratingEl.textContent='Ù†Ø§Ù…Ø´Ø®Øµ';episodesEl.textContent='Ù†Ø§Ù…Ø´Ø®Øµ';genresEl.innerHTML='';descriptionEl.textContent='';episodesList.innerHTML='';episodeDetails.innerHTML='';}
    function renderData(d){adminTitle.textContent='ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†ÛŒÙ…Ù‡';saveBtn.textContent='Ø°Ø®ÛŒØ±Ù‡';slugInput.disabled=true;slugInput.value=d.slug;titleEl.textContent=d.title||'';coverEl.src=d.image_url||'';const dt=new Date(d.release_date);dateEl.textContent=!isNaN(dt)?dt.toLocaleDateString('fa-IR'):'Ù†Ø§Ù…Ø´Ø®Øµ';ratingEl.textContent=d.rating??'Ù†Ø§Ù…Ø´Ø®Øµ';episodesEl.textContent=d.episodes??'Ù†Ø§Ù…Ø´Ø®Øµ';genresEl.innerHTML='';Array.isArray(d.genres)&&d.genres.forEach(g=>{const sp=document.createElement('span');sp.textContent=g;genresEl.append(sp);});descriptionEl.textContent=d.description||'';}
    function prepareForm(){titleInput.value=titleEl.textContent;descInput.value=descriptionEl.textContent;imgInput.value=coverEl.src;try{const dt=new Date(dateEl.textContent);dateInput.value=!isNaN(dt)?dt.toISOString().split('T')[0]:'';}catch{};genresInput.value=Array.from(genresEl.children).map(sp=>sp.textContent).join(',');ratingInput.value=ratingEl.textContent==='Ù†Ø§Ù…Ø´Ø®Øµ'?'':ratingEl.textContent;episodesInput.value=episodesEl.textContent==='Ù†Ø§Ù…Ø´Ø®Øµ'?'':episodesEl.textContent;fileInput.value='';generateEpisodeFields(episodeData);}
    // Save
    saveBtn.addEventListener('click',async()=>{const payload={slug:slugInput.value.trim(),title:titleInput.value.trim(),description:descInput.value.trim(),image_url:imgInput.value.trim()||null,release_date:dateInput.value||null,genres:genresInput.value?genresInput.value.split(',').map(s=>s.trim()):[],rating:ratingInput.value?parseFloat(ratingInput.value):null,episodes:episodesInput.value?parseInt(episodesInput.value):null,file_url:fileInput.value.trim()||null};if(newMode){const {data,error}=await supabase.from('anime').insert(payload).select().single();if(error){alert('Ø®Ø·Ø§:'+error.message);return;}currentId=data.id;newMode=false;}else{const {error}=await supabase.from('anime').update(payload).eq('id',currentId);if(error){alert('Ø®Ø·Ø§:'+error.message);return;}}await supabase.from('episodes').delete().eq('anime_id',currentId);const epCount=parseInt(episodesInput.value)||0;const epPayload=[];for(let i=1;i<=epCount;i++){const urlVal=document.getElementById(`episode-url-${i}`).value.trim()||null;epPayload.push({anime_id:currentId,episode_number:i,video_url:urlVal});}if(epPayload.length)await supabase.from('episodes').insert(epPayload);closeAdmin();loadAnime();});
    document.addEventListener('DOMContentLoaded',loadAnime);
  </script>
</body>
</html>
